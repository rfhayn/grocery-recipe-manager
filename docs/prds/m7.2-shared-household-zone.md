# M7.2: Shared Household Zone - Detailed PRD

**Component**: M7.2 - Shared Household Zone  
**Parent Milestone**: M7 - CloudKit Sync, Household Sharing & External TestFlight  
**Version**: 1.0  
**Created**: December 21, 2025  
**Status**: üöÄ READY TO START  
**Estimated Duration**: 8-10 hours (4 phases)  
**Prerequisites**: M7.0 Complete ‚úÖ, M7.1 Complete ‚úÖ

---

## üéØ Executive Summary

M7.2 implements CloudKit Shared Zone architecture to enable household members to automatically share ALL grocery lists, recipes, meal plans, and related data. Unlike CKShare (which shares individual items), this creates a single shared database that household members access collaboratively.

**Key Deliverables:**
- `Household` and `HouseholdMember` Core Data entities
- `HouseholdService` for shared zone management
- Settings ‚Üí Household UI for creation/management
- Invitation and acceptance flows
- Multi-device sync validation
- Household management (add/remove/leave/dissolve)

**User Value:**
- Couples/roommates share groceries and meal planning seamlessly
- No manual sharing per item - invite once, share everything
- Real-time sync across all household members' devices
- Like sharing an Apple Notes folder for all app data

---

## üìã Table of Contents

1. [Use Case & User Journey](#use-case--user-journey)
2. [Technical Architecture](#technical-architecture)
3. [Phase Breakdown](#phase-breakdown)
4. [Implementation Details](#implementation-details)
5. [Testing Strategy](#testing-strategy)
6. [Edge Cases](#edge-cases)
7. [Validation Criteria](#validation-criteria)

---

## üë• Use Case & User Journey

### **Primary Personas**

**Sarah (Owner):**
- Lives with partner Mike
- Primary grocery shopper and meal planner
- Uses iPhone 15
- iCloud account: sarah@icloud.com

**Mike (Member):**
- Lives with Sarah
- Shares grocery responsibilities
- Uses iPhone 14
- iCloud account: mike@icloud.com

---

### **Complete User Journey**

#### **Phase 1: Setup (One-Time)**

**Step 1: Sarah Creates Household**
```
Sarah: Opens Forager ‚Üí Settings ‚Üí Household
- Sees: "Create Household" card
- Taps: [Create Household]

Sheet appears:
"Create Household"
"Share your Forager data with household members. 
All recipes, lists, and meal plans will be shared automatically."

- Name field (pre-filled: "Sarah's Household")
- [Cancel] [Create] buttons

Sarah: Edits name to "Sarah & Mike's Home"
Sarah: Taps [Create]

Progress indicator: "Creating household..."

Result:
‚úÖ Household created in CloudKit shared zone
‚úÖ Sarah's existing data migrated to shared zone
‚úÖ Sarah sees: "Household" section now shows:
   - Name: "Sarah & Mike's Home"
   - Owner: sarah@icloud.com
   - Members: 1 (Sarah)
   - [Invite Member] button
```

**Step 2: Sarah Invites Mike**
```
Sarah: Taps [Invite Member]

UICloudSharingController presented:
- Pre-filled email field
- Standard iOS share options (Messages, Mail, AirDrop)

Sarah: Enters "mike@icloud.com"
Sarah: Taps [Send Invitation]

iCloud sends invitation to Mike

Sarah sees: 
- "Pending invitation sent to mike@icloud.com"
- Mike appears in member list with "Pending" status
```

**Step 3: Mike Accepts Invitation**
```
Mike: Receives iCloud notification on iPhone
Notification: "Sarah invited you to Sarah & Mike's Home"
Mike: Taps notification

Forager opens (or launches if not open):
Sheet appears:
"Join Household?"
"Sarah invited you to join Sarah & Mike's Home

You'll see all of Sarah's recipes, grocery lists, and meal plans. 
Any changes you make will be visible to all household members."

- Shows preview: "127 items" (recipes + lists + etc)
- [Decline] [Join Household] buttons

Mike: Taps [Join Household]

Progress indicator: "Joining household..."

Result:
‚úÖ Mike's app switches to shared zone
‚úÖ Mike sees ALL of Sarah's data instantly
‚úÖ Mike's Household section shows:
   - Name: "Sarah & Mike's Home"
   - Owner: sarah@icloud.com  
   - Members: 2 (Sarah, Mike)
   - Role: Member
   - [Leave Household] button

Sarah sees (on her device):
- Mike's "Pending" status changes to "Active"
- Member count updates to 2
```

---

#### **Phase 2: Daily Usage**

**Scenario 1: Collaborative Grocery List**
```
Sarah (on iPhone):
- Opens "This Week" grocery list
- Adds "Milk" 
- Adds "Eggs"

CloudKit sync: ~2-3 seconds

Mike (on iPhone):
- Already has "This Week" list open
- Sees "Milk" appear
- Sees "Eggs" appear
- Adds "Bread"

CloudKit sync: ~2-3 seconds

Sarah (on iPhone):
- Sees "Bread" appear
- Checks off "Milk"

Mike (on iPhone):  
- Sees "Milk" checked off
```

**Scenario 2: Recipe Sharing**
```
Sarah (on iPad):
- Creates "Chocolate Chip Cookies" recipe
- Adds ingredients
- Saves

CloudKit sync: ~2-3 seconds

Mike (on iPhone):
- Opens Recipes tab
- Sees "Chocolate Chip Cookies" appear automatically
- Stars as favorite ‚≠ê

CloudKit sync: ~2-3 seconds

Sarah (on iPad):
- Sees favorite star on her recipe
```

---

#### **Phase 3: Household Management**

**Scenario: Sarah Removes Mike (Edge Case)**
```
Sarah: Settings ‚Üí Household ‚Üí Mike ‚Üí [Remove Member]

Alert:
"Remove Mike from household?"
"Mike will lose access to all shared data. This cannot be undone."
[Cancel] [Remove Member]

Sarah: Taps [Remove Member]

Result:
‚úÖ CloudKit removes Mike from shared zone
‚úÖ Mike's app switches back to private zone
‚úÖ Mike's local data preserved (read-only copy)
‚úÖ Mike can no longer edit shared data
‚úÖ Mike sees alert: "You were removed from Sarah & Mike's Home"

Sarah sees:
- Mike removed from member list
- Member count: 1
```

**Scenario: Sarah Dissolves Household**
```
Sarah: Settings ‚Üí Household ‚Üí [Dissolve Household]

Alert:
"Dissolve Household?"
"All members will lose access. Your data will be moved back to your private iCloud storage."
[Cancel] [Dissolve]

Sarah: Taps [Dissolve]

Progress: "Dissolving household..."

Result:
‚úÖ CloudKit deletes shared zone
‚úÖ Sarah's data migrates to private zone
‚úÖ All members (if any) lose access
‚úÖ Sarah sees: "Create Household" option again

Mike sees:
- Alert: "Sarah & Mike's Home was dissolved"
- His local data preserved (read-only)
- Can export or start fresh
```

---

## üèóÔ∏è Technical Architecture

### **Core Data Model Changes**

**Two new entities will be added to the Core Data model:**

1. **Household Entity**
2. **HouseholdMember Entity**

**Key Design Decision**: Existing entities (Recipe, WeeklyList, MealPlan, etc.) require NO changes. When records are created in a shared zone, CloudKit automatically handles the sharing.

---

### **New Entity: Household**

**Attributes:**
- `id`: UUID (Primary Key)
- `name`: String (e.g., "Sarah & Mike's Home")
- `createdDate`: Date
- `ownerEmail`: String (iCloud email of creator)
- `shareRecord`: Binary Data (Archived CKShare object)

**Relationships:**
- `members`: To-Many ‚Üí HouseholdMember (Inverse: `household`)

**Codegen**: Class Definition

**Entity Configuration:**
```
Entity: Household
Class: Household (auto-generated)

Attributes:
- id: UUID, Optional: NO
- name: String, Optional: NO
- createdDate: Date, Optional: NO
- ownerEmail: String, Optional: NO
- shareRecord: Binary Data, Optional: YES, Allows External Storage: YES

Relationships:
- members: To-Many, Destination: HouseholdMember, Inverse: household, Delete Rule: Cascade

Fetch Indexes:
- ownerEmail (for quick owner lookup)
```

**Computed Properties (Manual Extensions):**
```swift
extension Household {
    public var isOwner: Bool {
        guard let ownerEmail = ownerEmail else { return false }
        return ownerEmail == getCurrentUserEmail()
    }
    
    public var memberCount: Int {
        return members?.count ?? 0
    }
    
    public var memberArray: [HouseholdMember] {
        let set = members as? Set<HouseholdMember> ?? []
        return set.sorted { ($0.joinedDate ?? Date.distantPast) < ($1.joinedDate ?? Date.distantPast) }
    }
}
```

---

### **New Entity: HouseholdMember**

**Attributes:**
- `id`: UUID (Primary Key)
- `email`: String (iCloud email)
- `displayName`: String (Extracted from email)
- `joinedDate`: Date (When accepted invitation)
- `role`: String ("owner" | "member")
- `status`: String ("active" | "pending")

**Relationships:**
- `household`: To-One ‚Üí Household (Inverse: `members`)

**Codegen**: Class Definition

**Entity Configuration:**
```
Entity: HouseholdMember
Class: HouseholdMember (auto-generated)

Attributes:
- id: UUID, Optional: NO
- email: String, Optional: NO
- displayName: String, Optional: YES
- joinedDate: Date, Optional: YES
- role: String, Optional: NO, Default: "member"
- status: String, Optional: NO, Default: "pending"

Relationships:
- household: To-One, Destination: Household, Inverse: members, Delete Rule: Nullify

Fetch Indexes:
- email (for quick member lookup)
- status (for filtering pending invitations)
```

**Computed Properties (Manual Extensions):**
```swift
extension HouseholdMember {
    public var isOwner: Bool {
        return role == "owner"
    }
    
    public var isPending: Bool {
        return status == "pending"
    }
    
    public var isActive: Bool {
        return status == "active"
    }
}
```

---

### **Service Layer: HouseholdService**

**Purpose**: Manages household creation, invitations, member management, and CloudKit shared zone operations.

**Key Methods:**

```swift
import CoreData
import CloudKit

class HouseholdService: ObservableObject {
    private let container: NSPersistentCloudKitContainer
    private let ckContainer: CKContainer
    
    @Published var currentHousehold: Household?
    @Published var isLoading: Bool = false
    @Published var error: HouseholdError?
    
    init(container: NSPersistentCloudKitContainer) {
        self.container = container
        self.ckContainer = CKContainer(identifier: "iCloud.com.richhayn.forager")
        loadCurrentHousehold()
    }
    
    // MARK: - Household Lifecycle
    
    /// Creates a new household and CloudKit shared zone
    /// - Parameter name: Household name (e.g., "Sarah & Mike's Home")
    /// - Returns: Created Household entity
    func createHousehold(name: String) async throws -> Household
    
    /// Dissolves the household and migrates data back to private zone
    /// - Parameter household: Household to dissolve (must be owner)
    func dissolveHousehold(_ household: Household) async throws
    
    // MARK: - Member Management
    
    /// Invites a new member to the household
    /// - Parameters:
    ///   - email: iCloud email address
    ///   - household: Target household
    func inviteMember(email: String, to household: Household) async throws
    
    /// Accepts a household invitation
    /// - Parameter household: Household to join
    func acceptInvitation(household: Household) async throws
    
    /// Removes a member from the household (owner only)
    /// - Parameter member: Member to remove
    func removeMember(_ member: HouseholdMember) async throws
    
    /// Leaves the household (member only)
    func leaveHousehold() async throws
    
    // MARK: - CloudKit Operations
    
    private func createSharedZone(for household: Household) async throws
    private func getShare(for household: Household) async throws -> CKShare?
    private func getCurrentUserEmail() async throws -> String
}
```

**Full implementation details provided in Phase Breakdown section.**

---

### **Persistence Configuration**

**Dynamic Database Scope:**

```swift
// Persistence.swift

init(inMemory: Bool = false) {
    container = NSPersistentCloudKitContainer(name: "forager")
    
    if let description = container.persistentStoreDescriptions.first {
        let cloudKitOptions = NSPersistentCloudKitContainerOptions(
            containerIdentifier: "iCloud.com.richhayn.forager"
        )
        
        // M7.2: Dynamic scope based on household membership
        if hasActiveHousehold() {
            cloudKitOptions.databaseScope = .shared
            print("‚òÅÔ∏è CloudKit shared zone enabled (Household mode)")
        } else {
            cloudKitOptions.databaseScope = .private
            print("‚òÅÔ∏è CloudKit private zone (Individual mode)")
        }
        
        description.cloudKitContainerOptions = cloudKitOptions
        
        // ... rest of configuration
    }
}

private func hasActiveHousehold() -> Bool {
    // Check if user has active household membership
    let request: NSFetchRequest<Household> = Household.fetchRequest()
    request.fetchLimit = 1
    
    do {
        let count = try container.viewContext.count(for: request)
        return count > 0
    } catch {
        return false
    }
}
```

---

## üìã Phase Breakdown

### **M7.2.1: Household Setup & Shared Zone (3.5-4.5 hours)**

**Purpose**: Create core entities (with ALL 8 entities household-scoped), service, and shared zone infrastructure

**Architectural Note**: All user-created entities receive explicit `household` relationship for security and consistency. See [ADR 008](../../architecture/008-shared-zone-architecture.md#critical-architecture-decision-all-entities-household-scoped).

---

#### **Task 1: Core Data Model (75 min)**

**ARCHITECTURAL DECISION**: All 8 user-created entities will have explicit `household` relationship for security, consistency, and future-proofing. See [ADR 008](../../architecture/008-shared-zone-architecture.md#critical-architecture-decision-all-entities-household-scoped) for complete rationale.

**Steps:**

1. Open `forager.xcdatamodeld` in Xcode
2. Create `Household` entity:
   - Click + at bottom left
   - Name: "Household"
   - Codegen: Class Definition
   - Add attributes:
     - id: UUID, Optional: NO
     - name: String, Optional: NO
     - createdDate: Date, Optional: NO
     - ownerEmail: String, Optional: NO
     - shareRecord: Binary Data, Optional: YES, Allows External Storage: YES
   - Add relationship:
     - members: To-Many, Destination: HouseholdMember, Delete Rule: Cascade
3. Create `HouseholdMember` entity:
   - Click + at bottom left
   - Name: "HouseholdMember"
   - Codegen: Class Definition
   - Add attributes:
     - id: UUID, Optional: NO
     - email: String, Optional: NO
     - displayName: String, Optional: YES
     - joinedDate: Date, Optional: YES
     - role: String, Optional: NO, Default: "member"
     - status: String, Optional: NO, Default: "pending"
   - Add relationship:
     - household: To-One, Destination: Household, Inverse: members, Delete Rule: Nullify
4. Set inverse relationships:
   - Household.members ‚Üî HouseholdMember.household
5. Add household relationships to **8 existing entities** (30 min):
   - GroceryItem: Add `household` relationship (To-One, Destination: Household, Optional: YES, Delete Rule: Nullify)
   - Recipe: Add `household` relationship (To-One, Destination: Household, Optional: YES, Delete Rule: Nullify)
   - WeeklyList: Add `household` relationship (To-One, Destination: Household, Optional: YES, Delete Rule: Nullify)
   - MealPlan: Add `household` relationship (To-One, Destination: Household, Optional: YES, Delete Rule: Nullify)
   - Tag: Add `household` relationship (To-One, Destination: Household, Optional: YES, Delete Rule: Nullify)
   - Ingredient: Add `household` relationship (To-One, Destination: Household, Optional: YES, Delete Rule: Nullify)
   - GroceryListItem: Add `household` relationship (To-One, Destination: Household, Optional: YES, Delete Rule: Nullify)
   - **IngredientTemplate**: Add `household` relationship (To-One, Destination: Household, Optional: YES, Delete Rule: Nullify)
6. Add fetch indexes:
   - Household: ownerEmail
   - HouseholdMember: email, status
7. Regenerate all Core Data property files (20 min):
   - Editor ‚Üí Create NSManagedObject Subclass
   - Select all modified entities (8 existing + 2 new = 10 total)
   - Replace existing property files
8. Build project (‚åòB) ‚Üí Verify no errors
9. Verify auto-generated classes in Derived Data
10. Verify CloudKit schema in Dashboard (should show household relationship on all entities)

**Validation:**
- ‚úÖ Build succeeds
- ‚úÖ No Core Data model errors
- ‚úÖ All 10 entity classes auto-generated (8 modified + 2 new)
- ‚úÖ CloudKit Dashboard shows household field on all 8 existing entities
- ‚úÖ All household relationships optional (nullify delete rule)

---

#### **Task 2: Manual Entity Extensions (30 min)**

**Create computed properties for easier data access:**

1. Create `Household+Extensions.swift`:

```swift
import CoreData

extension Household {
    /// Returns true if current user is the household owner
    public var isOwner: Bool {
        guard let ownerEmail = ownerEmail else { return false }
        // TODO: Get current user email from CloudKit
        return false  // Placeholder
    }
    
    /// Returns count of household members
    public var memberCount: Int {
        return members?.count ?? 0
    }
    
    /// Returns members as sorted array
    public var memberArray: [HouseholdMember] {
        let set = members as? Set<HouseholdMember> ?? []
        return set.sorted { 
            ($0.joinedDate ?? Date.distantPast) < ($1.joinedDate ?? Date.distantPast) 
        }
    }
}
```

2. Create `HouseholdMember+Extensions.swift`:

```swift
import CoreData

extension HouseholdMember {
    /// Returns true if member is household owner
    public var isOwner: Bool {
        return role == "owner"
    }
    
    /// Returns true if invitation is pending
    public var isPending: Bool {
        return status == "pending"
    }
    
    /// Returns true if member is active
    public var isActive: Bool {
        return status == "active"
    }
}
```

3. Build project ‚Üí Verify extensions compile

**Validation:**
- ‚úÖ Extension files created
- ‚úÖ Build succeeds
- ‚úÖ Computed properties accessible

---

#### **Task 3: HouseholdService Implementation (90 min)**

**Create the service that manages all household operations:**

1. Create `Services/HouseholdService.swift`
2. Implement class structure with @Published properties
3. Implement `createHousehold()` method
4. Implement `inviteMember()` method  
5. Implement `removeMember()` method
6. Implement `dissolveHousehold()` method
7. Implement CloudKit helper methods
8. Add comprehensive error handling

**Reference Implementation** (abbreviated - see architecture doc for full version):

```swift
import CoreData
import CloudKit

class HouseholdService: ObservableObject {
    private let container: NSPersistentCloudKitContainer
    private let ckContainer: CKContainer
    
    @Published var currentHousehold: Household?
    @Published var isLoading: Bool = false
    @Published var error: HouseholdError?
    
    init(container: NSPersistentCloudKitContainer) {
        self.container = container
        self.ckContainer = CKContainer(identifier: "iCloud.com.richhayn.forager")
        loadCurrentHousehold()
    }
    
    // MARK: - Public Interface
    
    func createHousehold(name: String) async throws -> Household {
        isLoading = true
        defer { isLoading = false }
        
        // Create household entity
        let household = Household(context: container.viewContext)
        household.id = UUID()
        household.name = name
        household.createdDate = Date()
        household.ownerEmail = try await getCurrentUserEmail()
        
        // Create owner as first member
        let owner = HouseholdMember(context: container.viewContext)
        owner.id = UUID()
        owner.email = household.ownerEmail
        owner.displayName = extractDisplayName(from: household.ownerEmail ?? "")
        owner.joinedDate = Date()
        owner.role = "owner"
        owner.status = "active"
        owner.household = household
        
        // Save to Core Data
        try container.viewContext.save()
        
        // Create CloudKit shared zone
        try await createSharedZone(for: household)
        
        await MainActor.run {
            self.currentHousehold = household
        }
        
        print("‚úÖ Household created: \(name)")
        return household
    }
    
    // ... other methods (see architecture doc)
    
    // MARK: - Helpers
    
    private func getCurrentUserEmail() async throws -> String {
        let userRecordID = try await ckContainer.userRecordID()
        let userRecord = try await ckContainer.publicCloudDatabase.record(for: userRecordID)
        
        guard let email = userRecord.value(forKey: "emailAddress") as? String else {
            throw HouseholdError.noEmail
        }
        
        return email
    }
    
    private func extractDisplayName(from email: String) -> String {
        return email.components(separatedBy: "@").first?.capitalized ?? "User"
    }
    
    private func loadCurrentHousehold() {
        let request: NSFetchRequest<Household> = Household.fetchRequest()
        request.fetchLimit = 1
        
        do {
            let households = try container.viewContext.fetch(request)
            currentHousehold = households.first
        } catch {
            print("‚ö†Ô∏è Failed to load household: \(error)")
        }
    }
}

enum HouseholdError: LocalizedError {
    case noShareRecord
    case notOwner
    case ownerCannotLeave
    case noEmail
    case invalidInvitation
    
    var errorDescription: String? {
        switch self {
        case .noShareRecord: return "Household share not found"
        case .notOwner: return "Only the household owner can perform this action"
        case .ownerCannotLeave: return "Owner must dissolve household instead of leaving"
        case .noEmail: return "Could not retrieve iCloud email address"
        case .invalidInvitation: return "Invalid invitation"
        }
    }
}
```

**Validation:**
- ‚úÖ Service compiles without errors
- ‚úÖ All methods have documentation
- ‚úÖ Error cases handled properly

---

#### **Task 4: Settings UI - Household Section (60 min)**

**Add household management to Settings:**

1. Open `SettingsView.swift`
2. Add `@StateObject` for HouseholdService
3. Add "Household" section to settings list
4. Conditional display based on household existence

**Implementation:**

```swift
struct SettingsView: View {
    @StateObject private var householdService: HouseholdService
    @State private var showingCreateSheet = false
    
    init() {
        let service = HouseholdService(container: PersistenceController.shared.container)
        _householdService = StateObject(wrappedValue: service)
    }
    
    var body: some View {
        List {
            // ... existing sections
            
            // M7.2: Household Section
            Section {
                if let household = householdService.currentHousehold {
                    NavigationLink {
                        HouseholdDetailView(household: household, service: householdService)
                    } label: {
                        VStack(alignment: .leading, spacing: 4) {
                            Text("Household")
                                .font(.headline)
                            Text(household.name ?? "Unknown")
                                .font(.subheadline)
                                .foregroundStyle(.secondary)
                        }
                    }
                } else {
                    Button {
                        showingCreateSheet = true
                    } label: {
                        Label("Create Household", systemImage: "house")
                    }
                }
            } header: {
                Text("Collaboration")
            } footer: {
                if householdService.currentHousehold == nil {
                    Text("Share your grocery lists, recipes, and meal plans with household members.")
                }
            }
        }
        .sheet(isPresented: $showingCreateSheet) {
            HouseholdCreateView(service: householdService)
        }
    }
}
```

**Validation:**
- ‚úÖ Settings shows Household section
- ‚úÖ Tapping "Create Household" shows sheet
- ‚úÖ Existing household shows detail navigation

---

#### **Task 5: Create Household UI (30 min)**

**Create the household creation sheet:**

Create `HouseholdCreateView.swift`:

```swift
import SwiftUI

struct HouseholdCreateView: View {
    @ObservedObject var service: HouseholdService
    @Environment(\.dismiss) private var dismiss
    
    @State private var householdName = ""
    @State private var isCreating = false
    
    var body: some View {
        NavigationStack {
            Form {
                Section {
                    TextField("Household Name", text: $householdName)
                } header: {
                    Text("Name")
                } footer: {
                    Text("Share your Forager data with household members. All recipes, lists, and meal plans will be shared automatically.")
                }
            }
            .navigationTitle("Create Household")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("Cancel") {
                        dismiss()
                    }
                }
                
                ToolbarItem(placement: .confirmationAction) {
                    Button("Create") {
                        Task {
                            await createHousehold()
                        }
                    }
                    .disabled(householdName.isEmpty || isCreating)
                }
            }
            .overlay {
                if isCreating {
                    ProgressView("Creating household...")
                }
            }
        }
        .onAppear {
            householdName = suggestedName()
        }
    }
    
    private func createHousehold() async {
        isCreating = true
        
        do {
            _ = try await service.createHousehold(name: householdName)
            dismiss()
        } catch {
            // Handle error
            print("‚ùå Failed to create household: \(error)")
        }
        
        isCreating = false
    }
    
    private func suggestedName() -> String {
        // Get user's first name from device if possible
        // For now, use generic name
        return "My Household"
    }
}
```

**Validation:**
- ‚úÖ Sheet presents correctly
- ‚úÖ Can enter household name
- ‚úÖ Create button works
- ‚úÖ Loading state shown during creation

---

#### **M7.2.1 Acceptance Criteria**

**Before moving to M7.2.2, verify:**

**Core Data Model:**
- ‚úÖ Household entity exists in Core Data model
- ‚úÖ HouseholdMember entity exists in Core Data model
- ‚úÖ All 8 existing entities have `household` relationship:
  - ‚úÖ GroceryItem.household (optional, to-one, nullify)
  - ‚úÖ Recipe.household (optional, to-one, nullify)
  - ‚úÖ WeeklyList.household (optional, to-one, nullify)
  - ‚úÖ MealPlan.household (optional, to-one, nullify)
  - ‚úÖ Tag.household (optional, to-one, nullify)
  - ‚úÖ Ingredient.household (optional, to-one, nullify)
  - ‚úÖ GroceryListItem.household (optional, to-one, nullify)
  - ‚úÖ IngredientTemplate.household (optional, to-one, nullify)
- ‚úÖ CloudKit Dashboard shows household field on all 8 entities
- ‚úÖ All property files regenerated (10 entities total)

**Service & UI:**
- ‚úÖ HouseholdService implemented with all methods
- ‚úÖ Settings ‚Üí Household section functional
- ‚úÖ User can tap "Create Household"
- ‚úÖ User can enter household name
- ‚úÖ Household created in Core Data
- ‚úÖ Owner added as first member
- ‚úÖ CloudKit shared zone created (verify in CloudKit Dashboard)

**Quality:**
- ‚úÖ Build succeeds with zero errors
- ‚úÖ No regressions to existing features
- ‚úÖ All existing M1-M5.0 features still working

---

### **M7.2.2: Member Invitation & Acceptance (2-3 hours)**

**Purpose**: Implement invitation sending and acceptance flows

[Detailed tasks and implementation continue for remaining phases M7.2.2, M7.2.3, M7.2.4...]

---

## üß™ Testing Strategy

### **Manual Testing Checklist**

**M7.2.1 Testing:**
- [ ] Create household with name "Test Home"
- [ ] Verify household appears in Settings
- [ ] Verify CloudKit Dashboard shows shared zone
- [ ] Verify owner is first member
- [ ] Verify member count = 1

**M7.2.2 Testing:**
- [ ] Send invitation to test email
- [ ] Verify pending member created
- [ ] Accept invitation (on second device)
- [ ] Verify member status = active
- [ ] Verify all data visible to member

**M7.2.3 Testing:**
- [ ] Run all 6 sync test scenarios
- [ ] Measure sync latency
- [ ] Verify no data loss
- [ ] Test concurrent edits

**M7.2.4 Testing:**
- [ ] Remove member (owner action)
- [ ] Verify member loses access
- [ ] Leave household (member action)
- [ ] Dissolve household (owner action)
- [ ] Verify data migration

---

## ‚úÖ Validation Criteria

### **M7.2 is COMPLETE when:**

**All Phases Complete:**
- ‚úÖ M7.2.1 acceptance criteria met
- ‚úÖ M7.2.2 acceptance criteria met
- ‚úÖ M7.2.3 acceptance criteria met
- ‚úÖ M7.2.4 acceptance criteria met

**Functional Requirements:**
- ‚úÖ User can create household
- ‚úÖ User can invite members
- ‚úÖ Members can accept invitations
- ‚úÖ All data syncs automatically across household
- ‚úÖ Sync latency < 5 seconds
- ‚úÖ Owner can remove members
- ‚úÖ Members can leave household
- ‚úÖ Owner can dissolve household

**Quality Requirements:**
- ‚úÖ Zero crashes during household operations
- ‚úÖ Zero data loss scenarios
- ‚úÖ All error cases handled gracefully
- ‚úÖ Performance targets met
- ‚úÖ CloudKit Dashboard shows correct structure

**Documentation:**
- ‚úÖ Code has comprehensive comments
- ‚úÖ All methods documented
- ‚úÖ Learning note created
- ‚úÖ Git commits follow M#.#.# format

**Integration:**
- ‚úÖ No regressions to existing features
- ‚úÖ All M1-M5.0 features still working
- ‚úÖ Build succeeds with zero warnings

---

## üìö References

**Architecture:**
- [M7 Shared Zone Architecture](../architecture/m7-shared-zone-architecture.md)
- [M7 Architecture Pivot](../learning-notes/25-m7-architecture-pivot-ckshare-vs-shared-zone.md)

**Apple Documentation:**
- [CloudKit Shared Zones](https://developer.apple.com/documentation/cloudkit/shared_records)
- [NSPersistentCloudKitContainer](https://developer.apple.com/documentation/coredata/nspersistentcloudkitcontainer)
- [CKShare](https://developer.apple.com/documentation/cloudkit/ckshare)

**Project Documentation:**
- [Session Startup Checklist](../session-startup-checklist.md)
- [Project Naming Standards](../project-naming-standards.md)
- [Development Guidelines](../development-guidelines.md)

---

**End of M7.2 PRD**

**Version**: 1.0  
**Status**: üöÄ Ready for Implementation  
**Next Step**: Complete session startup checklist, then begin M7.2.1
