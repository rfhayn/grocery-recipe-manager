# M7.5: Parsing Resilience & Polish - PRD

**Project**: Forager - Smart Meal Planner  
**Milestone**: M7.5  
**Status**: ⏳ PLANNED  
**Version**: 1.0  
**Created**: December 19, 2025  
**Dependencies**: M7.4 complete (Sync Status UI)

---

## Executive Summary

### What is M7.5?

M7.5 adds **graceful degradation** to ingredient parsing before external TestFlight launch. Instead of failing silently on edge cases, the app provides a professional "Edit Ingredient" flow and logs failures for future improvement.

### Why Now?

**Timing**: Between M7.4 (polish complete) and M7.6 (external TestFlight submission)

**Problem**: External beta testers will encounter edge cases like:
```
"2-3 cloves garlic, minced"
"1 can (14.5 oz) diced tomatoes"
"juice of 1 lemon"
"salt and pepper to taste"
```

Current parser (regex-based, 95% accuracy) fails these inputs, creating poor first impression.

**Solution**: 3-4 hours of work prevents 20+ hours of support tickets and embarrassment.

### Key Outcomes

By the end of M7.5:
- ✅ Low-confidence ingredient entries show "Review" indicator
- ✅ "Edit Ingredient" button opens structured form
- ✅ Failed parses logged to telemetry (prepares for M8.0)
- ✅ Professional UX even for unparseable ingredients
- ✅ Zero user frustration from parsing failures

---

## Strategic Context

### The Parsing Challenge Today

**Current State** (M3 implementation):
```swift
struct StructuredQuantity {
    let numericValue: Double?      // 2.0, 1.5, nil
    let standardUnit: String?      // "cup", "lb", "tsp"
    let displayText: String        // "2 cups"
    let isParseable: Bool          // Can be used in math
    let parseConfidence: Float     // 0.0-1.0
}
```

**Performance**: < 0.03s, 95%+ accuracy for common inputs

**Edge Cases That Fail**:
- Ranges: "2-3 cloves"
- Parentheticals: "1 can (14.5 oz)"
- Descriptive: "juice of 1 lemon"
- Qualifiers: "minced", "diced", "chopped"
- Compound: "to taste", "as needed"

### Strategic Roadmap

**Phase 1: M7.5** (NOW - 3-4h)
→ Graceful degradation with user correction UI
→ Start collecting failure data
→ Prevent external beta embarrassment

**Phase 2: M8.0** (After M7 - 8-12h)
→ Analyze M7 telemetry for patterns
→ Hybrid NLP system for complex cases
→ Data-driven improvement

**Phase 3: M9.5** (Future - 15-20h, OPTIONAL)
→ Custom ML model from user corrections
→ On-device inference
→ Industry-leading accuracy

**M7.5 is the foundation** for this 3-phase evolution.

---

## User Personas

### Primary: Sarah (Home Cook, External Beta Tester)

**Background**:
- First external beta tester
- Excited about Forager's meal planning
- Imports recipes from various websites

**Pain Point**:
- Copies "2-3 cloves garlic, minced" from recipe
- Parser fails → ingredient shows as "Unknown"
- Frustration → negative feedback

**M7.5 Solution**:
- Low-confidence detected (confidence < 0.5)
- Yellow "Review" badge appears
- Taps "Edit" → Structured form pre-filled with best guess
- Corrects to: 2.5 cloves, garlic
- Smooth experience → positive feedback

### Secondary: Rich (Developer, Portfolio Builder)

**Background**:
- Solo developer
- Using Forager for professional showcase
- Wants app to reflect production quality

**Pain Point**:
- Edge cases create "amateurish" feel
- Defensive about limitations in LinkedIn post
- Wish list grows faster than development capacity

**M7.5 Solution**:
- 3-4 hours = professional polish
- Confidence indicators show sophistication
- Telemetry = "this will get better over time"
- Can showcase graceful degradation as feature

---

## Goals & Success Criteria

### Functional Goals

**FG-1: Low-Confidence Detection**
- System recognizes when parsing has low confidence (< 0.5)
- Visual indicator shows "needs review" status
- User can proceed without correcting (non-blocking)

**FG-2: Structured Edit Flow**
- "Edit Ingredient" button accessible from any ingredient entry
- Opens sheet with pre-filled fields (quantity, unit, name)
- Manual adjustments override parsed values
- Saves correctly to Core Data with high confidence

**FG-3: Telemetry Foundation**
- Log ingredient text when parseConfidence < 0.5
- Log before/after for user corrections
- Store in local file (docs/telemetry/parsing-failures.json)
- Privacy-safe (no user identification)

### Non-Functional Goals

**NFG-1: Zero Regressions**
- All existing M1-M7.4 features work unchanged
- No performance degradation (< 0.5s targets maintained)
- Existing high-confidence parses unchanged

**NFG-2: Professional UX**
- UI elements match existing design system
- Visual indicators clear and unobtrusive
- Edit flow feels native and polished
- No "error" messaging (reframe as "customize")

**NFG-3: Future-Ready**
- Telemetry format supports M8.0 analysis
- UI extensible for ML-powered suggestions (M9.5)
- Architecture allows easy replacement of parser

### Success Criteria

**Must Have (P0):**
- [ ] Low-confidence entries show visual indicator
- [ ] "Edit Ingredient" opens structured form
- [ ] Manual edits save with confidence = 1.0
- [ ] Failed parses logged to local file
- [ ] Zero crashes or data loss
- [ ] Build succeeds with no warnings
- [ ] All M7.4 features still work

**Should Have (P1):**
- [ ] Yellow badge UI for low-confidence
- [ ] Pre-filled form with best-guess values
- [ ] Telemetry includes timestamp and context
- [ ] Help text explains "Review" indicator
- [ ] < 3-4 hours actual time spent

**Nice to Have (P2):**
- [ ] Batch edit multiple low-confidence items
- [ ] "Suggest" button for common patterns
- [ ] Export telemetry for analysis

---

## Phase Breakdown

### Phase 1: Low-Confidence UI Detection (1.5 hours)

**M7.5.1: Visual Indicators** (45 min)

*Goal*: Show low-confidence status without alarming users

*Implementation*:
```swift
// In IngredientRow or GroceryListItemRow
HStack {
    Text(ingredient.displayText)
    
    if ingredient.parseConfidence < 0.5 {
        Image(systemName: "exclamationmark.triangle.fill")
            .foregroundColor(.yellow)
            .font(.caption2)
            .help("Tap Edit to review this ingredient")
    }
}
```

*Files Modified*:
- `Views/Recipes/RecipeDetailView.swift`
- `Views/GroceryLists/GroceryListItemRow.swift`
- `Views/Recipes/AddIngredientsToListView.swift`

*Testing*:
- Create test ingredient with confidence = 0.3
- Verify yellow indicator appears
- Verify tooltip shows on hover (macOS) or long-press (iOS)

---

**M7.5.2: Edit Button Integration** (45 min)

*Goal*: Provide "Edit Ingredient" button for all ingredients

*Implementation*:
```swift
// In ingredient row contextual menu
.contextMenu {
    Button(action: { 
        editingIngredient = ingredient
        showEditSheet = true
    }) {
        Label("Edit Ingredient", systemImage: "pencil")
    }
}
.sheet(item: $editingIngredient) { ingredient in
    EditIngredientSheet(
        ingredient: ingredient,
        onSave: { updated in
            updateIngredient(ingredient, with: updated)
        }
    )
}
```

*Files Modified*:
- Create `Views/Shared/EditIngredientSheet.swift`
- Update `RecipeDetailView.swift`
- Update `GroceryListDetailView.swift`

*Testing*:
- Long-press ingredient → "Edit" appears
- Tap "Edit" → Sheet opens
- Verify sheet for both Recipe and GroceryListItem

---

### Phase 2: Structured Edit Form (1.5 hours)

**M7.5.3: Edit Sheet UI** (1 hour)

*Goal*: Professional form for manual ingredient entry

*UI Components*:
```swift
struct EditIngredientSheet: View {
    @State private var quantityText: String
    @State private var unitText: String
    @State private var nameText: String
    @State private var notes: String
    
    var body: some View {
        NavigationView {
            Form {
                Section("Quantity & Unit") {
                    TextField("Amount (e.g., 2, 1.5)", text: $quantityText)
                        .keyboardType(.decimalPad)
                    TextField("Unit (e.g., cups, tbsp)", text: $unitText)
                }
                
                Section("Ingredient") {
                    TextField("Name (e.g., flour)", text: $nameText)
                }
                
                Section("Notes (Optional)") {
                    TextField("e.g., to taste, minced", text: $notes)
                }
                
                if originalConfidence < 0.5 {
                    Section {
                        Text("Original text: \"\(originalText)\"")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                }
            }
            .navigationTitle("Edit Ingredient")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("Cancel") { dismiss() }
                }
                ToolbarItem(placement: .confirmationAction) {
                    Button("Save") { saveChanges() }
                }
            }
        }
    }
}
```

*Features*:
- Pre-filled with current values (or best guess from parsing)
- Keyboard types optimized (decimalPad for quantity)
- Shows original text for low-confidence entries
- Validation: quantity must be numeric if provided

*Files Created*:
- `Views/Shared/EditIngredientSheet.swift` (~150 lines)

---

**M7.5.4: Save & Update Logic** (30 min)

*Goal*: Update Core Data with manual corrections

*Implementation*:
```swift
func saveManualEdit(
    ingredient: Ingredient,
    quantity: String,
    unit: String,
    name: String,
    notes: String?
) {
    ingredient.numericValue = Double(quantity) ?? 0.0
    ingredient.standardUnit = unit.isEmpty ? nil : unit
    ingredient.displayText = formatDisplayText(quantity, unit, name)
    ingredient.isParseable = !quantity.isEmpty && Double(quantity) != nil
    ingredient.parseConfidence = 1.0  // Manual entry = max confidence
    ingredient.notes = notes
    
    // Save telemetry before saving Core Data
    if ingredient.parseConfidence < 0.5 {
        logParsingCorrection(
            original: ingredient.originalText,
            corrected: ingredient.displayText,
            confidence: ingredient.parseConfidence
        )
    }
    
    PersistenceController.shared.save()
}
```

*Files Modified*:
- `Services/IngredientParsingService.swift` (add manual override method)

*Testing*:
- Edit low-confidence ingredient
- Save changes
- Verify Core Data updated
- Verify yellow indicator removed (confidence now 1.0)

---

### Phase 3: Telemetry Logging (1 hour)

**M7.5.5: Telemetry Service** (45 min)

*Goal*: Log parsing failures for M8.0 analysis

*Implementation*:
```swift
struct ParsingFailure: Codable {
    let id: UUID
    let timestamp: Date
    let originalText: String
    let parseConfidence: Float
    let numericValue: Double?
    let standardUnit: String?
    let wasManuallyEdited: Bool
    let correctedText: String?
}

class ParsingTelemetryService {
    private let logFileURL: URL
    
    init() {
        // Save to Documents/telemetry/parsing-failures.json
        let docs = FileManager.default.urls(
            for: .documentDirectory, 
            in: .userDomainMask
        ).first!
        let telemetryDir = docs.appendingPathComponent("telemetry")
        try? FileManager.default.createDirectory(at: telemetryDir)
        logFileURL = telemetryDir.appendingPathComponent("parsing-failures.json")
    }
    
    func logParsingFailure(
        text: String,
        confidence: Float,
        numericValue: Double?,
        unit: String?
    ) {
        let failure = ParsingFailure(
            id: UUID(),
            timestamp: Date(),
            originalText: text,
            parseConfidence: confidence,
            numericValue: numericValue,
            standardUnit: unit,
            wasManuallyEdited: false,
            correctedText: nil
        )
        
        appendToLog(failure)
    }
    
    func logParsingCorrection(
        original: String,
        corrected: String,
        oldConfidence: Float
    ) {
        let correction = ParsingFailure(
            id: UUID(),
            timestamp: Date(),
            originalText: original,
            parseConfidence: oldConfidence,
            numericValue: nil,
            standardUnit: nil,
            wasManuallyEdited: true,
            correctedText: corrected
        )
        
        appendToLog(correction)
    }
    
    private func appendToLog(_ failure: ParsingFailure) {
        // Read existing log
        var failures: [ParsingFailure] = []
        if let data = try? Data(contentsOf: logFileURL),
           let existing = try? JSONDecoder().decode([ParsingFailure].self, from: data) {
            failures = existing
        }
        
        // Append new failure
        failures.append(failure)
        
        // Write back
        if let encoded = try? JSONEncoder().encode(failures) {
            try? encoded.write(to: logFileURL)
        }
    }
}
```

*Files Created*:
- `Services/ParsingTelemetryService.swift` (~120 lines)

*Integration Points*:
- Call `logParsingFailure()` in `IngredientParsingService.parseToStructured()`
- Call `logParsingCorrection()` in edit sheet save handler

---

**M7.5.6: Privacy Compliance** (15 min)

*Goal*: Ensure telemetry is privacy-safe

*Implementation*:
- No user identification (no name, email, iCloud ID)
- Only ingredient text (already user-provided)
- Local storage only (no upload to server)
- Can be deleted by user (Settings > Advanced > Clear Telemetry)

*Privacy Policy Update*:
```
## Telemetry Data

Forager may collect anonymous usage data to improve ingredient 
parsing accuracy. This data includes:
- Ingredient text you entered
- Whether the app successfully parsed it
- Your corrections (if you edited the ingredient)

This data:
- Is stored locally on your device
- Does not identify you personally
- Is never uploaded to our servers
- Can be deleted in Settings > Advanced > Clear Telemetry
```

*Files Modified*:
- `docs/privacy.html` (add telemetry section)
- `Views/Settings/SettingsView.swift` (add "Clear Telemetry" button)

---

## Technical Requirements

### TR-1: Zero Performance Impact

**Requirement**: M7.5 changes must not degrade performance

**Validation**:
```swift
// Parsing still < 0.05s
let start = CFAbsoluteTimeGetCurrent()
let parsed = parsingService.parseIngredient(text: "2 cups flour")
let duration = CFAbsoluteTimeGetCurrent() - start
XCTAssert(duration < 0.05, "Parsing took \(duration)s")

// UI updates < 0.1s
measure {
    // Edit ingredient, save, verify UI updates
}
XCTAssert(metrics.wallClockTime.average < 0.1)
```

### TR-2: Core Data Integrity

**Requirement**: All edits must save transactionally

**Validation**:
```swift
// Test rollback on error
let before = ingredient.displayText
do {
    try updateIngredient(ingredient, causing: error)
} catch {
    XCTAssertEqual(ingredient.displayText, before)
}
```

### TR-3: Backward Compatibility

**Requirement**: Existing ingredients work unchanged

**Validation**:
```swift
// High-confidence ingredients unaffected
let existing = createIngredient(text: "2 cups flour") // confidence 0.95
XCTAssertFalse(existing.needsReview)
XCTAssertEqual(existing.displayText, "2 cups flour")
```

---

## Risk Management

### Technical Risks

**Risk 1: Edit flow adds complexity to recipe entry**
- *Mitigation*: Edit is optional, doesn't block normal flow
- *Validation*: User can skip "Review" items and proceed

**Risk 2: Telemetry file grows unbounded**
- *Mitigation*: Add file size limit (10MB), rotate when exceeded
- *Validation*: Test with 1000+ failures, verify performance

**Risk 3: Time overrun (> 4 hours)**
- *Mitigation*: P2 features (batch edit, suggestions) are optional
- *Validation*: Track time per phase, cut scope if needed

### UX Risks

**Risk 1: Users ignore "Review" indicator**
- *Mitigation*: Non-blocking, doesn't prevent app usage
- *Validation*: Telemetry shows how often users edit

**Risk 2: Edit sheet too complex for casual users**
- *Mitigation*: Pre-filled with best guess, simple 3-field form
- *Validation*: External beta feedback (M7.6)

---

## Timeline & Estimation

### Phase-by-Phase Estimates

| Phase | Tasks | Time Estimate |
|-------|-------|---------------|
| **Phase 1** | Low-Confidence UI | **1.5 hours** |
| M7.5.1 | Visual indicators | 45 min |
| M7.5.2 | Edit button integration | 45 min |
| **Phase 2** | Structured Edit Form | **1.5 hours** |
| M7.5.3 | Edit sheet UI | 1 hour |
| M7.5.4 | Save & update logic | 30 min |
| **Phase 3** | Telemetry Logging | **1 hour** |
| M7.5.5 | Telemetry service | 45 min |
| M7.5.6 | Privacy compliance | 15 min |

**Total**: 4 hours (3-4 hour range)

**Buffer**: Already included in M7 total (35-46h)

---

## Integration Points

### Dependencies

**From M7.4 (Sync Status UI):**
- All CloudKit sync features complete
- App is polished and ready for external beta
- No major bugs or regressions

**To M7.6 (External TestFlight):**
- Professional UX for all ingredient inputs
- Graceful handling of edge cases
- Telemetry collection ready for M8.0

### Integration Testing

**Test Scenarios:**
1. High-confidence ingredient: No indicator, normal flow
2. Low-confidence ingredient: Yellow badge, can edit
3. Manual edit: Saves correctly, confidence → 1.0
4. Failed parse correction: Logged to telemetry
5. Multiple edits: All changes persist correctly
6. CloudKit sync: Edits sync across devices (M7.1+)

---

## Future Vision

### M8.0: Data-Driven Improvements
- Analyze telemetry from M7.6 external beta
- Identify top 10 failure patterns
- Implement hybrid NLP system to handle them
- Reduce low-confidence rate from 5% → 2%

### M9.5: ML-Powered Parsing (Optional)
- Train Create ML model on 100+ user corrections
- On-device inference for maximum privacy
- Self-improving system
- Industry-leading 98%+ accuracy

**M7.5 is the foundation** that makes M8.0 and M9.5 possible.

---

## Post-Milestone Documentation

### After M7.5 Completion

**Required Documentation Updates:**
1. **Learning Note**: Create `docs/learning-notes/25-m7.5-parsing-resilience.md`
   - Document edit flow implementation
   - Share telemetry service architecture
   - Note external beta user reactions
   - List any unexpected challenges

2. **Update current-story.md**: Mark M7.5 complete with actual hours

3. **Update roadmap.md**: Update M7.5 status, reference learning note

4. **Git Commit**: "M7.5 COMPLETE: Parsing resilience & telemetry foundation"

---

## Acceptance Criteria

### Must Have (P0) - Blocking M7.6

- [ ] Low-confidence ingredients show yellow indicator
- [ ] "Edit Ingredient" button accessible from context menu
- [ ] Edit sheet opens with pre-filled values
- [ ] Manual edits save to Core Data correctly
- [ ] parseConfidence set to 1.0 after manual edit
- [ ] Failed parses logged to telemetry file
- [ ] Zero crashes or data loss
- [ ] Zero regressions to M7.4 features
- [ ] Build succeeds with no warnings
- [ ] All existing tests still pass

### Should Have (P1) - Strong preference

- [ ] Yellow badge UI matches design system
- [ ] Tooltip/help text explains "Review" indicator
- [ ] Telemetry includes timestamp and context
- [ ] Privacy policy updated with telemetry section
- [ ] "Clear Telemetry" button in Settings
- [ ] Actual time: 3-4 hours

### Nice to Have (P2) - Future enhancement

- [ ] Batch edit multiple ingredients
- [ ] "Suggest" button for common patterns
- [ ] Export telemetry for analysis
- [ ] Statistics dashboard for parsing accuracy

---

## Getting Started

### Pre-Development Checklist

**Before M7.5.1:**
- [ ] Read session-startup-checklist.md
- [ ] Read project-naming-standards.md
- [ ] Read current-story.md
- [ ] Read M7.5 PRD (this document) completely
- [ ] Verify M7.4 completely finished and validated
- [ ] Have M7.6 external TestFlight submission planned

### First Session Start Prompt

```
I'm ready to start M7.5 - Parsing Resilience & Polish.

I've completed:
✅ session-startup-checklist.md
✅ project-naming-standards.md
✅ current-story.md
✅ M7.5 PRD review
✅ M7.4 validation complete

Let's start with M7.5.1: Visual Indicators for low-confidence ingredients.

Current state:
- IngredientParsingService returns parseConfidence (0.0-1.0)
- M3 structured quantity system operational
- M7.4 sync UI complete

First task: Add yellow indicator badge for ingredients with 
parseConfidence < 0.5 in RecipeDetailView and GroceryListItemRow.
```

---

**Version**: 1.0  
**Status**: ⏳ PLANNED  
**Estimated**: 3-4 hours  
**Dependencies**: M7.4 complete  
**Next Milestone**: M7.6 External TestFlight
