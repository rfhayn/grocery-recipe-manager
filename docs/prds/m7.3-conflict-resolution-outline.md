# M7.3: Conflict Resolution & Edge Cases - Outline

**Component**: M7.3 - Conflict Resolution & Edge Cases  
**Parent Milestone**: M7 - CloudKit Sync, Household Sharing & External TestFlight  
**Version**: 1.0 - Outline  
**Created**: December 21, 2025  
**Status**: â³ PLANNED (After M7.2)  
**Estimated Duration**: 4-6 hours (2 phases)  
**Prerequisites**: M7.2 Complete âœ…

---

## ğŸ¯ Purpose

Handle concurrent household edits, conflicts, and edge cases gracefully to ensure data integrity and user experience when multiple household members are actively using the app.

---

## ğŸ“‹ Phase Overview

### **M7.3.1: Conflict Resolution Strategy (2-3 hours)**

**Goal**: Define and implement conflict resolution policies for household zone

**Key Tasks:**
- Configure NSMergePolicy for household conflicts
  - Last-Write-Wins for most fields (NSMergeByPropertyObjectTrumpMergePolicy)
  - Array merging for list items and ingredients
  - Custom handling for critical fields (isChecked status)
- Add conflict logging for debugging
- Test concurrent edit scenarios between devices
- Implement conflict notification system (alert users when conflicts occur)

**Deliverables:**
- NSMergePolicy configurations in Persistence.swift
- Conflict logging service
- User-facing conflict notifications

**Test Scenarios:**
1. Sarah and Mike edit same grocery item name simultaneously â†’ Last write wins
2. Sarah checks off "Milk" while Mike edits quantity â†’ Both changes preserved
3. Sarah deletes recipe while Mike edits it â†’ Graceful handling with notification
4. Rapid concurrent edits to same list â†’ All edits captured, no data loss

---

### **M7.3.2: Edge Case Handling (2-3 hours)**

**Goal**: Handle household lifecycle and sync edge cases

**Edge Cases to Address:**

**1. Member Removed While Editing**
- Scenario: Mike editing list, Sarah removes him
- Handling: Save attempt fails gracefully, Mike notified, local data preserved

**2. Household Dissolved While Member Active**
- Scenario: Sarah dissolves household while Mike has app open
- Handling: Mike receives notification, switches to private zone, data preserved

**3. Offline â†’ Online with Conflicts**
- Scenario: Mike offline 24h, makes changes, comes online
- Handling: Changes queue, sync on reconnect, conflicts resolved per M7.3.1

**4. Network Timeout During Sync**
- Scenario: Sync operation times out
- Handling: Retry with exponential backoff, user notified if persistent failure

**5. CloudKit Quota Exceeded**
- Scenario: Household exceeds iCloud storage
- Handling: Clear error message, link to iCloud settings, prevent data loss

**6. Simultaneous Household Creation**
- Scenario: User taps Create twice rapidly
- Handling: Button disabled during creation, loading indicator shown

**7. Invalid Email Invitation**
- Scenario: Owner invites invalid email
- Handling: Email validation, clear error message

**Deliverables:**
- Edge case handling in HouseholdService
- User-facing error messages
- Recovery mechanisms for each scenario
- Comprehensive error logging

---

## âœ… Acceptance Criteria

**M7.3 Complete When:**

**Conflict Resolution:**
- âœ… Concurrent edits merge correctly (no data loss)
- âœ… Last-write-wins policy works for simple fields
- âœ… Array merging preserves both users' edits
- âœ… Users notified of conflicts appropriately
- âœ… Conflict logging captures all scenarios

**Edge Cases:**
- âœ… Member removed mid-edit â†’ handled gracefully
- âœ… Household dissolved â†’ all members notified
- âœ… Offline queue â†’ syncs correctly on reconnect
- âœ… Network timeout â†’ retry with backoff
- âœ… Quota exceeded â†’ clear error message
- âœ… Invalid email â†’ validation prevents submission
- âœ… Duplicate creation â†’ prevented

**Quality:**
- âœ… Zero crashes from edge cases
- âœ… Zero data loss scenarios
- âœ… All error messages user-friendly
- âœ… Recovery mechanisms work correctly

---

## ğŸ§ª Testing Strategy

**Test Matrix:**

| Scenario | Expected Behavior | Validation |
|----------|------------------|------------|
| Concurrent name edit | Last write wins | âœ… Both users see final value |
| Concurrent array add | Both items preserved | âœ… Both items appear in list |
| Delete during edit | Graceful failure | âœ… Editor notified, no crash |
| 24h offline sync | Changes queue | âœ… All changes sync on reconnect |
| Network timeout | Retry with backoff | âœ… Eventually succeeds or clear error |
| Quota exceeded | Error shown | âœ… Link to iCloud settings |

---

## ğŸ“š Implementation Notes

**Key Decisions to Make During Implementation:**

1. **Conflict Notification Style**
   - Option A: Silent resolution (log only)
   - Option B: Passive notification (toast)
   - Option C: Active alert (only for critical conflicts)
   - Recommendation: Combination (silent for minor, alert for major)

2. **Offline Queue Size**
   - Unlimited (risk: memory issues)
   - Limited (e.g., 100 operations)
   - Recommendation: 100 operations with warning at 80%

3. **Retry Strategy**
   - Exponential backoff: 1s, 2s, 4s, 8s, 16s
   - Max retries: 5
   - Give up and notify user after max retries

**These decisions will be finalized during M7.3 implementation based on testing results.**

---

## ğŸ”— References

- [M7 Shared Zone Architecture](../architecture/m7-shared-zone-architecture.md) - Edge cases section
- [Apple: NSMergePolicy](https://developer.apple.com/documentation/coredata/nsmergepolicy)
- [CloudKit Error Handling](https://developer.apple.com/documentation/cloudkit/ckerror)

---

**Status**: â³ Outline Complete - Detailed PRD will be created after M7.2 completion  
**Next**: M7.2 completion â†’ M7.3 detailed planning â†’ Implementation
