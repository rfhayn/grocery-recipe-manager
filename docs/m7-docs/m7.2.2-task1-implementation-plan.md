# M7.2.2 Task 1: Update HouseholdService with Invitation Methods

**Status**: üöÄ READY  
**Estimated Time**: 60-90 minutes  
**Phase**: M7.2.2 Member Invitation & Acceptance

---

## üéØ Goal

Implement invitation and acceptance methods in HouseholdService to enable:
1. Household owner can invite members via email
2. Invited users can accept invitation
3. Pending members tracked until acceptance
4. Member status updates from "pending" ‚Üí "active"

---

## üìã Tasks

### **Task 1.1: Add getShare() Helper Method (15 min)**

**Purpose**: Retrieve the CKShare for a household to enable invitation

**Implementation**:
```swift
/// Gets the CKShare record for the household
/// Used for invitation and share management
private func getShare(for household: Household) async throws -> CKShare {
    guard let shareData = household.shareRecord else {
        throw HouseholdError.noShareRecord
    }
    
    // Unarchive the CKShare from stored data
    guard let share = try NSKeyedUnarchiver.unarchivedObject(
        ofClass: CKShare.self,
        from: shareData
    ) else {
        throw HouseholdError.noShareRecord
    }
    
    return share
}
```

---

### **Task 1.2: Implement inviteMember() Method (20 min)**

**Purpose**: Create pending member and return share for UICloudSharingController

**Flow**:
1. Verify caller is household owner
2. Check if email already a member
3. Create pending HouseholdMember record
4. Get CKShare for presentation
5. Return share (UI will present UICloudSharingController)

**Implementation**:
```swift
/// Invites a member to the household by creating a pending member record
/// Owner must then present UICloudSharingController with the returned share
/// - Parameters:
///   - email: iCloud email address of person to invite
///   - household: Household to invite them to
/// - Returns: CKShare to present in UICloudSharingController
func inviteMember(email: String, to household: Household) async throws -> CKShare {
    isLoading = true
    defer { isLoading = false }
    
    do {
        // 1. Verify caller is owner
        guard await isOwner(household: household) else {
            throw HouseholdError.notOwner
        }
        
        // 2. Check if already a member
        let existingMember = household.memberArray.first { $0.email == email }
        if let existing = existingMember {
            if existing.isActive {
                throw HouseholdError.invitationFailed("User is already a member")
            } else {
                throw HouseholdError.invitationFailed("Invitation already pending")
            }
        }
        
        // 3. Create pending member
        let pendingMember = HouseholdMember(context: viewContext)
        pendingMember.id = UUID()
        pendingMember.email = email
        pendingMember.displayName = extractDisplayName(from: email)
        pendingMember.role = "member"
        pendingMember.status = "pending"
        pendingMember.household = household
        // joinedDate remains nil until acceptance
        
        // 4. Save pending member
        try viewContext.save()
        
        // 5. Get share for UICloudSharingController
        let share = try await getShare(for: household)
        
        print("‚úÖ Pending invitation created for: \(email)")
        return share
        
    } catch {
        print("‚ùå Invitation failed: \(error)")
        if let hhError = error as? HouseholdError {
            throw hhError
        } else {
            throw HouseholdError.invitationFailed(error.localizedDescription)
        }
    }
}
```

---

### **Task 1.3: Implement acceptInvitation() Method (20 min)**

**Purpose**: Accept invitation and activate member status

**Flow**:
1. Verify invitation exists (pending member record)
2. Update member status to "active"
3. Set joinedDate
4. Save changes

**Implementation**:
```swift
/// Accepts a household invitation
/// Called when user taps "Join Household" after receiving invitation
/// - Parameter household: Household being joined
func acceptInvitation(for household: Household) async throws {
    isLoading = true
    defer { isLoading = false }
    
    do {
        // 1. Get current user's email
        let currentEmail = try await getCurrentUserEmail()
        
        // 2. Find pending member record
        guard let pendingMember = household.memberArray.first(where: { 
            $0.email == currentEmail && $0.isPending 
        }) else {
            throw HouseholdError.invitationFailed("No pending invitation found")
        }
        
        // 3. Activate member
        pendingMember.status = "active"
        pendingMember.joinedDate = Date()
        
        // 4. Save changes
        try viewContext.save()
        
        // 5. Update current household
        currentHousehold = household
        
        print("‚úÖ Invitation accepted")
        print("‚úÖ Member activated: \(currentEmail)")
        print("‚úÖ Joined household: \(household.name ?? "Unknown")")
        
    } catch {
        print("‚ùå Failed to accept invitation: \(error)")
        throw HouseholdError.invitationFailed(error.localizedDescription)
    }
}
```

---

### **Task 1.4: Add Helper - extractDisplayName() (5 min)**

**Purpose**: Extract friendly name from email for display

**Implementation**:
```swift
/// Extracts display name from email address
/// Example: "sarah.smith@icloud.com" ‚Üí "Sarah Smith"
private func extractDisplayName(from email: String) -> String {
    // Get part before @
    let localPart = email.components(separatedBy: "@").first ?? email
    
    // Split by dots and capitalize each part
    let parts = localPart.components(separatedBy: ".")
    let capitalized = parts.map { $0.capitalized }
    
    return capitalized.joined(separator: " ")
}
```

---

### **Task 1.5: Update HouseholdError Enum (5 min)**

**Purpose**: Add new error cases for invitation flow

**Add to existing HouseholdError**:
```swift
enum HouseholdError: LocalizedError {
    // ... existing cases
    case noShareRecord
    case notOwner
    case cloudKitUnavailable
    case emailNotFound
    case creationFailed(String)
    case invitationFailed(String)
    case alreadyMember           // NEW
    case invitationPending       // NEW
    case noInvitation            // NEW
    
    var errorDescription: String? {
        switch self {
        // ... existing cases
        case .alreadyMember:
            return "This person is already a member of the household"
        case .invitationPending:
            return "An invitation is already pending for this email"
        case .noInvitation:
            return "No pending invitation found"
        }
    }
}
```

---

## üß™ Testing Plan

### **Manual Testing (Simulator - Limited)**

**Test 1: Owner Creates Pending Invitation**
```swift
// In Settings ‚Üí Household
// 1. Tap "Invite Member"
// 2. Enter test email: test@icloud.com
// 3. Verify pending member created in Core Data
// 4. Verify status = "pending"
// 5. Verify joinedDate = nil
```

**Expected**: Pending member appears in household.memberArray

**Test 2: Duplicate Invitation Prevention**
```swift
// 1. Try to invite same email twice
// 2. Verify error: "Invitation already pending"
```

**Expected**: Error thrown, no duplicate member created

### **Full Testing (Physical Devices - M7.2.3)**

**Note**: Full invitation flow requires:
- 2+ physical devices with iCloud accounts
- Production CloudKit environment
- UICloudSharingController integration (M7.2.2 Task 2)

Will test complete flow in M7.2.3:
```
Device A (Owner): Invite member ‚Üí Present share sheet ‚Üí Send
Device B (Member): Receive notification ‚Üí Accept ‚Üí Verify access
```

---

## ‚úÖ Acceptance Criteria

**Code Quality:**
- ‚úÖ All methods include comprehensive doc comments
- ‚úÖ Error handling covers all edge cases
- ‚úÖ Code follows existing HouseholdService patterns
- ‚úÖ No hardcoded values (email validation, etc.)

**Functionality:**
- ‚úÖ `inviteMember()` creates pending member and returns CKShare
- ‚úÖ `acceptInvitation()` activates member and sets joinedDate
- ‚úÖ Duplicate invitation prevention works
- ‚úÖ Owner verification prevents non-owners from inviting

**Integration:**
- ‚úÖ Methods ready for UICloudSharingController (Task 2)
- ‚úÖ Pending member tracking works
- ‚úÖ No regressions to existing household creation

---

## üìù Next Steps

After Task 1 complete:

**M7.2.2 Task 2**: UICloudSharingController Integration (30-45 min)
- Create ShareSheet wrapper
- Add "Invite Member" UI in Settings
- Present share controller with CKShare from `inviteMember()`

**M7.2.2 Task 3**: Acceptance Flow UI (30-45 min)
- Detect incoming share
- Present "Join Household?" sheet
- Call `acceptInvitation()` on accept

**M7.2.2 Task 4**: Member List UI (30 min)
- Display pending and active members
- Show role badges (Owner/Member)
- Show status (Pending/Active)

---

## üîç Code Review Checklist

Before committing:
- [ ] All methods have doc comments
- [ ] Error cases handled with appropriate HouseholdError
- [ ] Print statements for debugging included
- [ ] extractDisplayName() handles edge cases (no @, no dots, etc.)
- [ ] No force unwraps or force casts
- [ ] Async/await used correctly
- [ ] @MainActor boundaries respected
- [ ] Build succeeds with zero warnings

---

**Version**: 1.0  
**Created**: December 23, 2025  
**Next**: Implement code changes
